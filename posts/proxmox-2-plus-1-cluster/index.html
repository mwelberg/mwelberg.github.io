<!DOCTYPE html>
<html lang="de">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Proxmox 2&#43;1 Cluster &middot; moritzwelberg.de</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="moritzwelberg.de" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">moritzwelberg.de</h2>
				</a>
				<ul>
    
    
        <li>
            <a href="https://moritzwelberg.de/about/">
                
                <span>About</span>
                
            </a>
        </li>
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
        <br>
        <time datetime="2021-02-17 14:09:08 &#43;0100 &#43;0100">17. Februar 2021</time>
</div>

		<h1 class="post-title">Proxmox 2&#43;1 Cluster</h1>
<div class="post-line"></div>

		

		

<h1 id="einleitung">Einleitung</h1>

<p>Auf meinem Heimserver (HP1) läuft die Virtualisierungsumgebung <a href="https://www.proxmox.com/en/">Proxmox</a>.<br />
Um der Umgebung mehr Speicherplatz und Rechenkapazität hinzuzufügen, bietet Proxmox die Möglichkeit ein &ldquo;Cluster&rdquo; aus mehreren Rechnern zu bilden.<br />
Dieses Cluster kann dann über die Weboberfläche zentral verwaltet werden, was den Umgang mit mehreren Knoten deutlich vereinfacht.<br />
Das Einbinden eines zweiten Knotens (HP2) über die Kommandozeile gestaltet sich <a href="https://pve.proxmox.com/pve-docs/chapter-pvecm.html#pvecm_cluster_create_via_cli">sehr einfach</a>.</p>

<pre><code>HP1# pvecm create &lt;CLUSTERNAME&gt;
</code></pre>

<p>Wobei <em>HP1</em> der erste Knoten des Clusters ist.<br />
Mit dem Befehl:</p>

<pre><code>HP2# pvecm add &lt;IP-ADDRESS-HP1&gt;
</code></pre>

<p>Kann auf dem zweiten Knoten <em>HP2</em> eine Einbindung in das Cluster durchgeführt werden.<br />
Mehr ist dazu nicht nötig. Allerdings wurde mir nach einigen Tagen klar, dass es dann doch nicht ganz so einfach sein sollte.</p>

<h1 id="problem">Problem</h1>

<p>Nach dem Einbinden eines zweiten Knotens, fällt dieser regelmäßig aus und muss neu gestartet werden.<br />
Diese Unerreichbarkeit des Knotens bringt es mit sich, dass die konfigurierten Backup-Jobs nicht mehr fehlerfrei ausgeführt werden können.<br />
Bei meinen Suchanfragen zu dem Problem wird nach kurzer Zeit klar: Ein &ldquo;Cluster&rdquo;, bestehend aus nur zwei Knoten, ist ein Sonderfall.<br />
Das Voting-Protokoll, implementiert durch die Cluster Engine <a href="https://corosync.github.io/corosync/">Corosync</a>, benötigt über 50% Stimmanteile für eine Entscheidung. Erhält es diese Anteile nicht, wird das Cluster Handlungsunfähig.<br />
Gibt also nur einer der beiden Knoten im Zuge der Synchronisationskommunikation keine, oder eine, vom anderen Knoten abweichende Rückmeldung, können keine Entscheidungen mehr getroffen werden.</p>

<h1 id="ursachen">Ursachen</h1>

<p>Häufige Ursachen für ausbleibende Rückmeldungen von Diensten sind z.B. der Ausfall des Dienstes, oder eine Überlastung des Netzwerks.<br />
Lassen sich in den Log-Dateien keine Ausfälle der Proxmox Dienste feststellen, festigt sich der Verdacht, dass die Netzwerkverbindung das Problem ist.<br />
Die zuvor erwähnten, fehlerhaften Backup-Jobs scheinen an der Stelle sowohl Symptom, als auch Ursache der Problematik zu sein.
Während der Ausführung dieser Jobs wird unter Umständen der Switch, oder eine der beiden Netzwerkschnittstellen der Server voll ausgelastet, sodass Vorgaben in der Timeout-Konfiguration des Voting-Protokolls nicht mehr eingehalten werden.<br />
Mögliche Lösungen werden im <a href="https://forum.proxmox.com/threads/cluster-fails-after-one-day-pve-6-0-4.56181/">Proxmox Forum</a> vorgeschlagen.<br />
Die Vorschläge sind teilweise naheliegende Hardwarelösungen, wie z.B. eine Direktverbindung der Knoten über ein vermaschtes Netz, oder ein Austausch des Switches. An anderer Stelle wird vorgeschlagen das Problem durch Anheben der timeout-Konfiguration zu lösen, was allerdings von den Proxmox Entwicklern nicht empfohlen wird.</p>

<h1 id="lösung">Lösung</h1>

<p>Der wohl sicherste Lösungsweg wird ebenfalls im Forum von den Entwicklern erwähnt. Nämlich die Einrichtung eines <a href="https://pve.proxmox.com/pve-docs/chapter-pvecm.html#_corosync_external_vote_support">Corosync Quorum Device</a>. Dabei handelt es sich um ein externes Gerät, welches mit dem &ldquo;Blick von außen&rdquo; auf alle Knoten des Clusters in die Entscheidungsfindung eingreifen kann.<br />
Wenn bei Backups die Netzwerkverbindung zu einem Knoten abbricht, kann bei Wiederaufnahme der Verbindung mithilfe des externen Geräts entschieden werden, welcher Konfigurationsstatus auf allen Knoten als gültig betrachtet wird.<br />
Mit dem Befehl:</p>

<pre><code>PI# apt install corosync-qnetd
</code></pre>

<p>kann auf einem weiteren, dauerhaften Netzwerkteilnehmer, wie z.B. einem Raspberry-Pi das <em>corosync-qnetd</em> Paket installiert werden.<br />
Im Anschluss müssen alle Knoten des Clusters mit dem Paket <em>corosync-qdevice</em> ausgestattet werden:</p>

<pre><code>HP1# apt install corosync-qdevice
HP2# apt install corosync-qdevice
</code></pre>

<p>Zum Schluss muss auf einem Knoten noch die Eigentliche Einrichtung des QDevice durchgeführt werden:</p>

<pre><code>HP1# pvecm qdevice setup &lt;IP-ADDRESS-PI&gt;
</code></pre>

<p>Seither läuft das Cluster auch mit nur Zwei Knoten und einem QDevice problemlos.</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/gitlab-shell-deployment/" class="left arrow">&#8592;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-07-31 20:16:27.279354016 &#43;0000 UTC m=&#43;0.078630341">2021</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
